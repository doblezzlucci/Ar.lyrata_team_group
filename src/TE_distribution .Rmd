---
title: "R Notebook"
output: html_notebook
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Cmd+Shift+Enter*. 

```{r}
# ===============================
# Visualizing RepeatMasker output
# ===============================

library(ggplot2)
library(dplyr)
library(stringr)

# -------------------------------
# 1. Read RepeatMasker summary
# -------------------------------
file="~/Desktop/geniomhe/comparative _genomics /TE/all genome lyrata /Galaxy126-[RepeatMasker repeat statistics on dataset 118 and 120].txt"
dir="~/Desktop/geniomhe/comparative _genomics /TE/all genome lyrata "
lines <- readLines(file)

# Keep only lines with bp and %
data_lines <- lines[str_detect(lines, "bp") & str_detect(lines, "%")]

# Parse table
rm_df <- data.frame(
  raw = data_lines,
  stringsAsFactors = FALSE
)

rm_df <- rm_df %>%
  mutate(
    category = str_trim(
      str_extract(raw,"^[A-Za-z0-9/\\- ]+")
    ),
    bp = as.numeric(str_replace_all(
      str_extract(raw, "[0-9,]+(?= bp)"), ",", ""
    )),
    percent = as.numeric(
      str_extract(raw, "[0-9.]+(?= %)")
    )
  ) %>%
  filter(!is.na(bp))

```

```{r}


```


```{r}

rm_df$category <- sub("\\s{2,}.*", "", rm_df$category)
unique(rm_df$category)
```



```{r}
# -------------------------------
# 2. High-level TE composition
# -------------------------------
main_classes <- c(
  "Retroelements",
  "DNA transposons",
  "Rolling-circles",
  "Unclassified",
  "Small RNA",
  "Simple repeats",
  "Low complexity"
)

te_main <- rm_df %>%
  filter(category %in% main_classes)

# Barplot
ggplot(te_main, aes(x=reorder(category, percent), y=percent, fill=category)) +
  geom_bar(stat="identity") +
  coord_flip() +
  theme_minimal() +
  labs(
    title="RepeatMasker TE composition",
    x="Repeat class",
    y="Genome fraction (%)"
  ) +
  theme(legend.position="none")

ggsave(file.path(dir,"TE_composition_barplot.png"), width=7, height=5)

# Pie chart
ggplot(te_main, aes(x="", y=percent, fill=category)) +
  geom_bar(stat="identity", width=1) +
  coord_polar("y") +
  theme_void() +
  labs(title="Genome repeat composition")

ggsave(file.path(dir,"TE_composition_pie.png"), width=6, height=6)

```


```{r}
# -------------------------------
# 3. Detailed TE subclasses
# -------------------------------
subclasses <- c(
  "SINEs",
  "LTR elements",
  "Ty1/Copia",
  "Gypsy/DIRS1",
  "LINEs",
  "L1/CIN4",
  "RTE/Bov-B",
  "DNA transposons",
  "hobo-Activator",
  "MULE-MuDR")

te_sub <- rm_df %>%
  filter(category %in% subclasses & percent >= 0)

ggplot(te_sub, aes(x=reorder(category, percent), y=percent, fill=category)) +
  geom_bar(stat="identity") +
  coord_flip() +
  theme_minimal() +
  labs(
    title="TE subclass distribution",
    x="TE subclass",
    y="Genome fraction (%)"
  ) +
  theme(legend.position="none")

ggsave(file.path(dir,"TE_subclass_distribution.png"), width=7, height=5)
```

